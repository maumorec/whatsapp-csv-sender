<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Clientes WhatsApp</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 16px; }
    table { border-collapse: collapse; width: 100%; }
    th, td { border: 1px solid #ddd; padding: 8px; }
    th { background: #f2f2f2; }
    .enviado { background: #c8f7c5; }
    .no { background: #fff; }
    button { cursor: pointer; }
  </style>
</head>
<body>

<h1>Env√≠o WhatsApp</h1>
<p id="progreso" style="font-weight:bold; margin-bottom:12px;"></p>

<table id="tabla">
  <thead>
    <tr>
      <th>N¬∞</th>
      <th>Nombre</th>
      <th>Tel√©fono</th>
      <th>Estado</th>
      <th>Acci√≥n</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

<script>
async function cargarCSV() {
  const res = await fetch('./clientes_ejemplo.csv?' + Date.now());
  if (!res.ok) {
    alert('No se pudo cargar clientes_ejemplo.csv');
    return;
  }

  let texto = await res.text();
  texto = texto.replace(/^\uFEFF/, '');

  const lineas = texto.split(/\r?\n/).filter(l => l.trim() !== '');
  const tbody = document.querySelector('#tabla tbody');
  tbody.innerHTML = '';

  let enviados = 0;
  const total = lineas.length - 1;

  for (let i = 1; i < lineas.length; i++) {
    const columnas = lineas[i].split(';');
    if (columnas.length < 3) continue;

    const numero   = columnas[0].trim();
    const nombre   = columnas[1].trim();
    const telefono = columnas[2].trim();

    const key = `enviado_${telefono}`;
    const enviado = localStorage.getItem(key) === '1';
    if (enviado) enviados++;

    const tr = document.createElement('tr');
    tr.className = enviado ? 'enviado' : 'no';

    tr.innerHTML = `
      <td>${numero}</td>
      <td>${nombre}</td>
      <td>${telefono}</td>
      <td>${enviado ? 'ENVIADO' : 'NO'}</td>
      <td>
        <button onclick="enviarWhatsApp('${nombre}','${telefono}', this)">
          WhatsApp
        </button>
      </td>
    `;

    tbody.appendChild(tr);
  }

  document.getElementById('progreso').textContent =
    `Enviados: ${enviados} de ${total}`;
}

function enviarWhatsApp(nombre, telefono, btn) {
  // marcar como enviado
  localStorage.setItem(`enviado_${telefono}`, '1');

  const fila = btn.closest('tr');
  fila.className = 'enviado';
  fila.children[3].textContent = 'ENVIADO';

  // actualizar contador en vivo
  const progreso = document.getElementById('progreso');
  const m = progreso.textContent.match(/(\d+)\s*de\s*(\d+)/);
  if (m) {
    const enviados = Number(m[1]) + 1;
    const total = m[2];
    progreso.textContent = `Enviados: ${enviados} de ${total}`;
  }

  // MENSAJE ORIGINAL ‚Äî NO MODIFICADO
  const mensaje =
`Hola ${nombre} üëã‚ú®

Comenzar el a√±o dedicando tiempo para ti tambi√©n es una forma de cuidarte ü§ç

Tenemos promociones activas en tratamientos corporales y depilaci√≥n l√°ser, pensadas para ayudarte a verte y sentirte m√°s c√≥moda este verano üåø

Cualquier duda, feliz de orientarte y ayudarte a elegir lo que mejor se adapte a ti üòä`;

  // abrir WhatsApp
  window.open(
    'https://api.whatsapp.com/send?phone=' +
    telefono +
    '&text=' +
    encodeURIComponent(mensaje),
    '_blank'
  );
}

cargarCSV();
</script>

</body>
</html>
